{% extends 'base.html' %}
{% load static %}

{% block title %}New Color Analysis{% endblock %}
<link rel="stylesheet" href="{% static 'css/styles.css' %}">
{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">

{% endblock %}

{% block content %}
<head>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
</head>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="text-center mb-4">
                <h1 class="display-5 text-muted">New Color Analysis</h1>
                <p class="lead text-muted">Upload photos to analyze your color type</p>
            </div>

            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}

            <form method="post" enctype="multipart/form-data" id="analizaForm">
                {% csrf_token %}
                
                <!-- Wrist photo -->
                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fas fa-hand-paper me-2"></i>
                        Wrist Photo
                    </h3>
                    <div class="upload-section" data-field="zdjecie_nadgarstka">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <h5>Drag and drop a photo or click to select</h5>
                        <p class="text-muted">Take a photo of the inner wrist in natural light</p>
                        {{ form.zdjecie_nadgarstka }}
                        <div class="file-info">
                            Max size: 5MB | Allowed formats: JPG, PNG, GIF
                        </div>

                        <div class="preview-container">
                            <img class="preview-image" alt="Preview">
                        </div>

                        <div class="text-center mt-2">
                            <button type="button" class="btn btn-outline-primary crop-btn">Crop</button>
                        </div>
                        <input type="hidden" class="cropped-data" name="cropped_{{ form.zdjecie_nadgarstka.name }}">

                        <div class="progress-container">
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    {% if form.zdjecie_nadgarstka.errors %}
                        <div class="text-danger mt-2">
                            {% for error in form.zdjecie_nadgarstka.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- Eyes photo -->
                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fas fa-eye me-2"></i>
                        Eye Photo
                    </h3>
                    <div class="upload-section" data-field="zdjecie_oczu">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <h5>Drag and drop a photo or click to select</h5>
                        <p class="text-muted">Take a close-up of your eyes in good lighting</p>
                        {{ form.zdjecie_oczu }}
                        <div class="file-info">
                            Max size: 5MB | Allowed formats: JPG, PNG, GIF
                        </div>
                        <div class="preview-container">
                            <img class="preview-image" alt="Preview">
                        </div>

                        <div class="text-center mt-2">
                            <button type="button" class="btn btn-outline-primary crop-btn">Crop</button>
                        </div>
                        <input type="hidden" class="cropped-data" name="cropped_{{ form.zdjecie_oczu.name }}">

                        <div class="progress-container">
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    {% if form.zdjecie_oczu.errors %}
                        <div class="text-danger mt-2">
                            {% for error in form.zdjecie_oczu.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- Hair photo -->
                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fas fa-cut me-2"></i>
                        Hair Photo
                    </h3>
                    <div class="upload-section" data-field="zdjecie_wlosow">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <h5>Drag and drop a photo or click to select</h5>
                        <p class="text-muted">Take a photo of your hair in natural light</p>
                        {{ form.zdjecie_wlosow }}
                        <div class="file-info">
                            Max size: 5MB | Allowed formats: JPG, PNG, GIF
                        </div>
                        <div class="preview-container">
                            <img class="preview-image" alt="Preview">
                        </div>

                        <div class="text-center mt-2">
                            <button type="button" class="btn btn-outline-primary crop-btn">Crop</button>
                        </div>
                        <input type="hidden" class="cropped-data" name="cropped_{{ form.zdjecie_wlosow.name }}">

                        <div class="progress-container">
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    {% if form.zdjecie_wlosow.errors %}
                        <div class="text-danger mt-2">
                            {% for error in form.zdjecie_wlosow.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- Buttons -->
                <div class="form-section text-center">
                    <button type="submit" class="btn-artnouveau btn-lg me-3">
                        <i class="fas fa-paper-plane me-2"></i>
                        Send for analysis
                    </button>
                    <a href="{% url 'color_analyzer:historia_analiz' %}" class="btn-artnouveau btn-lg">
                        <i class="fas fa-history me-2"></i>
                        Analysis History
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}  
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    
    const activeCroppers = new Map();

    document.querySelectorAll('.upload-section').forEach(section => {
        const input = section.querySelector('input[type="file"]');
        const previewContainer = section.querySelector('.preview-container');
        const preview = section.querySelector('.preview-image');
        const cropBtn = section.querySelector('.crop-btn');
        const hiddenInput = section.querySelector('.cropped-data');
        const fieldName = section.dataset.field;

        
        activeCroppers.set(fieldName, {
            cropper: null,
            isInitialized: false
        });

       
        input.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('Please select an image file.');
                return;
            }

            section.style.borderColor = '#dee2e6';

            const reader = new FileReader();
            reader.onload = function (event) {
                preview.src = event.target.result;
                previewContainer.style.display = 'block';

                const sectionData = activeCroppers.get(fieldName);
                if (sectionData && sectionData.cropper) {
                    sectionData.cropper.destroy();
                    console.log(`Destroyed existing cropper for ${fieldName}`);
                }

                activeCroppers.set(fieldName, {
                    cropper: null,
                    isInitialized: false
                });


                preview.onload = function() {
                    console.log(`Image loaded for ${fieldName}, initializing cropper...`);
                    
                    if (typeof Cropper === 'undefined') {
                        console.error('Cropper.js library is not loaded!');
                        alert('Cropper.js library is not loaded. Please check if the script is properly included.');
                        return;
                    }
                    

                    if (!preview.complete || preview.naturalWidth === 0) {
                        console.log('Image not fully loaded, waiting...');
                        setTimeout(() => preview.onload(), 100);
                        return;
                    }
                    
                    try {
                        console.log(`Creating cropper for ${fieldName}...`);
                        
                        setTimeout(() => {
                            try {
                                const newCropper = new Cropper(preview, {
                                    aspectRatio: 1, 
                                    viewMode: 2, 
                                    autoCropArea: 0.9, 
                                    responsive: true,
                                    restore: false,
                                    checkCrossOrigin: false,
                                    
                                    guides: true,
                                    center: true,
                                    highlight: true,
                                    background: true,
                                    
                                    cropBoxMovable: true,
                                    cropBoxResizable: true,
                                    toggleDragModeOnDblclick: true, 
                                    
                                    minCropBoxHeight: 100,
                                    minCropBoxWidth: 100,
                                    
                                    wheelZoomRatio: 0.1,
                                    
                                    ready() {
                                        console.log(`Cropper ready for ${fieldName}`);
                                        
                                        addCropperControls(section, newCropper, fieldName);
                                        
                                        activeCroppers.set(fieldName, {
                                            cropper: newCropper,
                                            isInitialized: true
                                        });
                                    },
                                    error(error) {
                                        console.error(`Cropper error for ${fieldName}:`, error);
                                        alert('Error creating cropping tool.');
                                    }
                                });
                                
                                console.log(`Cropper instance created for ${fieldName}`);
                                
                            } catch (innerError) {
                                console.error(`Inner error creating cropper for ${fieldName}:`, innerError);
                                alert('Error creating cropper: ' + innerError.message);
                            }
                        }, 50);

                    } catch (error) {
                        console.error(`Error initializing cropper for ${fieldName}:`, error);
                        alert('Error initializing cropping tool: ' + error.message);
                    }
                };

                preview.onerror = function() {
                    console.error(`Error loading image for ${fieldName}`);
                    alert('Error loading image. Try selecting another file.');
                };
            };

            reader.onerror = function() {
                console.error(`Error reading file for ${fieldName}`);
                alert('Error reading file. Please try again.');
            };

            reader.readAsDataURL(file);
        });

        cropBtn?.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();

            console.log(`Crop button clicked for ${fieldName}`);

            const sectionData = activeCroppers.get(fieldName);
            
            if (!sectionData) {
                console.error(`No section data found for ${fieldName}`);
                alert('Internal error. Please try refreshing the page.');
                return;
            }

            const cropper = sectionData.cropper;

            if (!preview.src || preview.src === '') {
                alert('Please select a photo first.');
                return;
            }

            if (!cropper || !sectionData.isInitialized) {
                alert('Cropping tool is not ready yet. Please wait a moment and try again.');
                return;
            }

            try {
                console.log(`Starting crop process for ${fieldName}`);

                const originalText = cropBtn.innerHTML;
                cropBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cropping...';
                cropBtn.disabled = true;

                const canvas = cropper.getCroppedCanvas({
                    width: 600, 
                    height: 600,
                    imageSmoothingEnabled: true,
                    imageSmoothingQuality: 'high',
                    fillColor: '#fff' 
                });

                if (!canvas) {
                    throw new Error('Cannot generate cropped image');
                }

                const croppedDataURL = canvas.toDataURL('image/jpeg', 0.92);
                
                if (!croppedDataURL || croppedDataURL === 'data:,') {
                    throw new Error('Error generating image data');
                }

                if (hiddenInput) {
                    hiddenInput.value = croppedDataURL;
                } else {
                    throw new Error('Cannot save data - hidden input missing');
                }

                preview.src = croppedDataURL;
                
                const controls = section.querySelector('.cropper-controls');
                if (controls) {
                    controls.style.display = 'none';
                }

                cropBtn.innerHTML = '<i class="fas fa-check text-success"></i> Cropped!';
                cropBtn.classList.remove('btn-outline-primary');
                cropBtn.classList.add('btn-outline-success');

                setTimeout(() => {
                    cropBtn.innerHTML = '<i class="fas fa-edit"></i> Edit again';
                    cropBtn.disabled = false;
                    
                    cropBtn.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        if (controls) {
                            controls.style.display = 'flex';
                        }
                        
                        cropBtn.innerHTML = '<i class="fas fa-cut"></i> Crop';
                        cropBtn.classList.remove('btn-outline-success');
                        cropBtn.classList.add('btn-outline-primary');
                       
                    };
                }, 1500);

                console.log(`Crop process completed successfully for ${fieldName}`);

            } catch (error) {
                console.error(`Error during crop process for ${fieldName}:`, error);
                alert('Error during cropping: ' + error.message);
                
                cropBtn.innerHTML = originalText;
                cropBtn.disabled = false;
            }
        });


        section.addEventListener('click', (e) => {
            if (e.target.closest('.crop-btn') || e.target.closest('.preview-container')) return;
            if (e.target !== input) input.click();
        });


        section.addEventListener('dragover', (e) => {
            e.preventDefault();
            section.classList.add('drag-over');
        });

        section.addEventListener('dragleave', (e) => {
            e.preventDefault();
            section.classList.remove('drag-over');
        });

        section.addEventListener('drop', (e) => {
            e.preventDefault();
            section.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length) {
                if (!files[0].type.startsWith('image/')) {
                    alert('Please drop an image file.');
                    return;
                }
                input.files = files;
                input.dispatchEvent(new Event('change'));
            }
        });
    });

    
    function addCropperControls(section, cropper, fieldName) {
        
        if (section.querySelector('.cropper-controls')) {
            return;
        }

        const controlsDiv = document.createElement('div');
        controlsDiv.className = 'cropper-controls mt-2 d-flex justify-content-center gap-2 flex-wrap';
        controlsDiv.innerHTML = `
            <button type="button" class="btn btn-sm btn-outline-secondary zoom-in-btn" title="Zoom In">
                <i class="fas fa-search-plus"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary zoom-out-btn" title="Zoom Out">
                <i class="fas fa-search-minus"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary reset-btn" title="Reset">
                <i class="fas fa-undo"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary rotate-left-btn" title="Rotate Left">
                <i class="fas fa-undo"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary rotate-right-btn" title="Rotate Right">
                <i class="fas fa-redo"></i>
            </button>
        `;

        const cropBtn = section.querySelector('.crop-btn');
        cropBtn.parentNode.insertBefore(controlsDiv, cropBtn);

       
        controlsDiv.querySelector('.zoom-in-btn').addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            cropper.zoom(0.1);
        });

        controlsDiv.querySelector('.zoom-out-btn').addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            cropper.zoom(-0.1);
        });

        controlsDiv.querySelector('.reset-btn').addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            cropper.reset();
        });

        controlsDiv.querySelector('.rotate-left-btn').addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            cropper.rotate(-90);
        });

        controlsDiv.querySelector('.rotate-right-btn').addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            cropper.rotate(90);
        });
    }

   
    document.getElementById('analizaForm')?.addEventListener('submit', function (e) {
        const requiredFields = [
            'id_zdjecie_nadgarstka',
            'id_zdjecie_oczu',
            'id_zdjecie_wlosow'
        ];

        let hasError = false;
        let missingFields = [];

        requiredFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            const hiddenInput = document.querySelector(`input[name="cropped_${field?.name}"]`);
            
            const hasOriginalFile = field && field.files && field.files.length > 0;
            const hasCroppedData = hiddenInput && hiddenInput.value && hiddenInput.value.trim() !== '';
            
            if (!hasOriginalFile && !hasCroppedData) {
                hasError = true;
                missingFields.push(field?.name || fieldId);
                const section = field?.closest('.upload-section');
                if (section) section.style.borderColor = '#dc3545';
            }
        });

        if (hasError) {
            e.preventDefault();
            console.log('Form validation failed. Missing fields:', missingFields);
            alert('Please upload and crop all required photos before submitting the form.');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        } else {
            console.log('Form validation passed');
        }
    });

   
});
</script>

{% endblock %}
